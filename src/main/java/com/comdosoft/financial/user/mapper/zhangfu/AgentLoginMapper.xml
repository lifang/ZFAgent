<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.comdosoft.financial.user.mapper.zhangfu.AgentLoginMapper">

	<insert id="addUser" useGeneratedKeys="true" keyProperty="id" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer">
		INSERT  into customers(username,password,city_id,account_type,types,phone,email,created_at,status)
		VALUES(#{username},#{password},#{cityId},#{accountType},#{types},#{phone},#{email},now(),#{status})
	</insert>
	
	<insert id="addAgent" useGeneratedKeys="true" keyProperty="id" parameterType="com.comdosoft.financial.user.domain.zhangfu.Agent">
		insert into agents(name,card_id,types,company_name,business_license,
						phone,email,customer_id,address,form_types,parent_id,status,is_have_profit,created_at,updated_at,code,
						card_id_photo_path,tax_registered_no,license_no_pic_path,tax_no_pic_path)
		values(#{name},#{cardId},#{types},#{companyName},#{businessLicense},#{phone},#{email},#{customerId},#{address},#{formTypes},
						#{parentId},#{status},#{isHaveProfit},now(),now(),#{code},#{cardIdPhotoPath},#{taxRegisteredNo},#{licenseNoPicPath},#{taxNoPicPath})
	</insert>

	<select id="doLogin" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer" resultType="object">
 		SELECT id 
 		FROM customers 
 		WHERE username=#{username} and password=#{password} and types=#{types}
 	</select>
 	
	<update id="updateLastLoginedAt" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer">
		UPDATE customers set last_logined_at=now()
		WHERE username=#{username}
	</update>
	
	<update id="updatePassword" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer">
		UPDATE customers set `password`=#{password},updated_at=now()
		WHERE username=#{username}
	</update>
	
	<select id="findUname" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer" resultType="int">
		SELECT COUNT(*) from customers 
		WHERE username=#{username}
	</select>
	
	<select id="judgeCityId" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer" resultType="int">
		SELECT count(*) FROM customers WHERE  city_id=#{cityId} and status = #{status}
	</select>
	
	<select id="getAgentCode" resultType="object">
		SELECT max(agent_code) FROM agents
	</select>
	
	<select id="Toestemming" resultType="map" parameterType="com.comdosoft.financial.user.domain.zhangfu.Customer">
		SELECT s.menu_name FROM  customers c 
		LEFT JOIN customer_role_relations r ON r.customer_id=c.id
		LEFT JOIN role_menus m ON m.role_id = r.role_id
		LEFT JOIN menus s ON s.id = m.menu_id
		WHERE C.username=#{username}
	</select>
</mapper>